import{a as l,r as e,f as a,o as s,k as t,l as n,n as o,q as i,t as u,z as d,A as r,D as c,C as v,F as b,s as m,e as p,v as y,G as f}from"./vendor-vue-IgQ0LSVQ.js";import{u as h}from"./index-iiR0jBps.js";import{_ as k}from"./_plugin-vue_export-helper-BCo6x5W8.js";const g={class:"container-fluid py-4"},w={key:0,class:"alert alert-info"},C={key:1,class:"alert alert-danger alert-dismissible fade show",role:"alert"},x={key:2,class:"alert alert-warning"},E={key:3},$={class:"card mb-3"},T={class:"card-body"},_={class:"row g-3"},j={class:"col-md-6"},A={class:"col-md-6"},L={class:"table-responsive"},N={class:"table table-hover align-middle"},U={class:"text-muted"},P={key:0},V={key:1},D=["onClick"],H=["onClick"],I={class:"text-muted mt-3"},q={key:4,class:"modal fade show d-block",style:{"background-color":"rgba(0, 0, 0, 0.5)"},tabindex:"-1",role:"dialog"},z={class:"modal-dialog",role:"document"},F={class:"modal-content"},G={class:"modal-header"},J={class:"modal-title"},M={class:"modal-body"},O=["id","value"],S=["for"],B={class:"text-muted d-block ms-4"},K={class:"modal-footer"},Q=["disabled"],R={key:0,class:"spinner-border spinner-border-sm me-2",role:"status"},W={key:5,class:"modal fade show d-block",style:{"background-color":"rgba(0, 0, 0, 0.5)"},tabindex:"-1",role:"dialog"},X={class:"modal-dialog",role:"document"},Y={class:"modal-content"},Z={class:"modal-header bg-danger text-white"},ll={class:"modal-body"},el={class:"modal-footer"},al=["disabled"],sl={key:0,class:"spinner-border spinner-border-sm me-2",role:"status"},tl=k(l({__name:"UsersManageView",setup(l){const k=h(),tl=e([]),nl=e(!1),ol=e(null),il=e(""),ul=e(""),dl=e(!1),rl=e(!1),cl=e(null),vl=e([]),bl=e(!1),ml=e(!1),pl=a(()=>{var l;return(null==(l=k.user)?void 0:l.id)||""}),yl=[{value:"Admin",label:"管理員",description:"擁有系統全部存取權限"},{value:"Customer",label:"客戶",description:"可查詢塔位和參加問卷調查"},{value:"Employee",label:"員工",description:"系統幹部角色"},{value:"Company",label:"公司",description:"宗親會會員角色"}],fl=a(()=>tl.value.filter(l=>{const e=l.userName.toLowerCase().includes(il.value.toLowerCase())||l.email.toLowerCase().includes(il.value.toLowerCase()),a=""===ul.value||l.roles&&l.roles.includes(ul.value);return e&&a}));function hl(l){return{Admin:"bg-danger",Customer:"bg-info",Employee:"bg-warning",Company:"bg-success"}[l]||"bg-secondary"}async function kl(){nl.value=!0,ol.value=null;try{const l=await fetch("/api/admin/users",{credentials:"include"});if(401===l.status)return void(ol.value="未授權。請先登入。");if(!l.ok)throw new Error(`HTTP ${l.status}`);tl.value=await l.json()}catch(l){ol.value=`加載失敗: ${l.message}`}finally{nl.value=!1}}async function gl(){if(cl.value){bl.value=!0;try{const l=await fetch(`/api/admin/users/${cl.value.id}/roles`,{method:"PUT",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({roles:vl.value})});if(401===l.status)return void(ol.value="未授權。請先登入。");if(!l.ok)throw new Error(`HTTP ${l.status}`);cl.value.roles=vl.value,dl.value=!1}catch(l){ol.value=`保存失敗: ${l.message}`}finally{bl.value=!1}}}async function wl(){if(cl.value){ml.value=!0;try{const l=await fetch(`/api/admin/users/${cl.value.id}`,{method:"DELETE",credentials:"include"});if(401===l.status)return void(ol.value="未授權。請先登入。");if(!l.ok)throw new Error(`HTTP ${l.status}`);tl.value=tl.value.filter(l=>{var e;return l.id!==(null==(e=cl.value)?void 0:e.id)}),rl.value=!1,cl.value=null}catch(l){ol.value=`刪除失敗: ${l.message}`}finally{ml.value=!1}}}async function Cl(){await kl()}return s(()=>kl()),(l,e)=>{var a,s,h;return p(),t("div",g,[n("div",{class:"row mb-4"},[e[9]||(e[9]=n("div",{class:"col-md-8"},[n("h2",{class:"mb-0"},"會員管理與角色分配"),n("p",{class:"text-muted"},"管理系統使用者和分配角色權限")],-1)),n("div",{class:"col-md-4 text-end"},[n("button",{class:"btn btn-success",onClick:Cl},[...e[8]||(e[8]=[n("i",{class:"bi bi-arrow-clockwise"},null,-1),i(" 刷新 ",-1)])])])]),nl.value?(p(),t("div",w,[...e[10]||(e[10]=[n("div",{class:"spinner-border spinner-border-sm me-2",role:"status"},[n("span",{class:"visually-hidden"},"加載中...")],-1),i(" 加載會員清單中... ",-1)])])):ol.value?(p(),t("div",C,[e[11]||(e[11]=n("strong",null,"錯誤",-1)),i(" "+u(ol.value)+" ",1),n("button",{type:"button",class:"btn-close",onClick:e[0]||(e[0]=l=>ol.value=null)})])):0===fl.value.length?(p(),t("div",x,[...e[12]||(e[12]=[n("i",{class:"bi bi-info-circle"},null,-1),i(" 無會員記錄 ",-1)])])):(p(),t("div",E,[n("div",$,[n("div",T,[n("div",_,[n("div",j,[d(n("input",{"onUpdate:modelValue":e[1]||(e[1]=l=>il.value=l),type:"text",class:"form-control",placeholder:"搜尋用戶名或電郵..."},null,512),[[r,il.value]])]),n("div",A,[d(n("select",{"onUpdate:modelValue":e[2]||(e[2]=l=>ul.value=l),class:"form-select"},[...e[13]||(e[13]=[v('<option value="" data-v-99a99fc4>所有角色</option><option value="Admin" data-v-99a99fc4>管理員</option><option value="Customer" data-v-99a99fc4>客戶</option><option value="Employee" data-v-99a99fc4>員工</option><option value="Company" data-v-99a99fc4>公司</option>',5)])],512),[[c,ul.value]])])])])]),n("div",L,[n("table",N,[e[17]||(e[17]=n("thead",{class:"table-light"},[n("tr",null,[n("th",{style:{width:"5%"}},"ID"),n("th",{style:{width:"15%"}},"用戶名"),n("th",{style:{width:"20%"}},"電郵"),n("th",{style:{width:"35%"}},"角色"),n("th",{style:{width:"25%"}},"操作")])],-1)),n("tbody",null,[(p(!0),t(b,null,m(fl.value,l=>(p(),t("tr",{key:l.id},[n("td",null,[n("code",U,u(l.id.substring(0,8))+"...",1)]),n("td",null,[n("strong",null,u(l.userName),1)]),n("td",null,u(l.email),1),n("td",null,[l.roles&&l.roles.length>0?(p(),t("div",P,[(p(!0),t(b,null,m(l.roles,l=>(p(),t("span",{key:l,class:y(["badge",hl(l)])},u(function(l){return{Admin:"管理員",Customer:"客戶",Employee:"員工",Company:"公司"}[l]||l}(l)),3))),128))])):(p(),t("div",V,[...e[14]||(e[14]=[n("span",{class:"text-muted"},"無角色",-1)])]))]),n("td",null,[n("button",{class:"btn btn-sm btn-primary",onClick:e=>function(l){cl.value=l,vl.value=[...l.roles||[]],dl.value=!0}(l),title:"編輯角色"},[...e[15]||(e[15]=[n("i",{class:"bi bi-pencil"},null,-1),i(" 編輯角色 ",-1)])],8,D),l.id!==pl.value?(p(),t("button",{key:0,class:"btn btn-sm btn-danger ms-2",onClick:e=>function(l){cl.value=l,rl.value=!0}(l),title:"刪除用戶"},[...e[16]||(e[16]=[n("i",{class:"bi bi-trash"},null,-1)])],8,H)):o("",!0)])]))),128))])])]),n("div",I,[n("small",null,"共 "+u(fl.value.length)+" 名會員",1)])])),dl.value?(p(),t("div",q,[n("div",z,[n("div",F,[n("div",G,[n("h5",J,"編輯角色 - "+u(null==(a=cl.value)?void 0:a.userName),1),n("button",{type:"button",class:"btn-close",onClick:e[3]||(e[3]=l=>dl.value=!1)})]),n("div",M,[(p(),t(b,null,m(yl,l=>n("div",{class:"form-check",key:l.value},[d(n("input",{class:"form-check-input",type:"checkbox",id:`role-${l.value}`,value:l.value,"onUpdate:modelValue":e[4]||(e[4]=l=>vl.value=l)},null,8,O),[[f,vl.value]]),n("label",{class:"form-check-label",for:`role-${l.value}`},u(l.label),9,S),n("small",B,u(l.description),1)])),64))]),n("div",K,[n("button",{type:"button",class:"btn btn-secondary",onClick:e[5]||(e[5]=l=>dl.value=!1)}," 取消 "),n("button",{type:"button",class:"btn btn-primary",onClick:gl,disabled:bl.value},[bl.value?(p(),t("span",R,[...e[18]||(e[18]=[n("span",{class:"visually-hidden"},"保存中...",-1)])])):o("",!0),e[19]||(e[19]=i(" 保存 ",-1))],8,Q)])])])])):o("",!0),rl.value?(p(),t("div",W,[n("div",X,[n("div",Y,[n("div",Z,[e[20]||(e[20]=n("h5",{class:"modal-title"},"確認刪除",-1)),n("button",{type:"button",class:"btn-close btn-close-white",onClick:e[6]||(e[6]=l=>rl.value=!1)})]),n("div",ll,[n("p",null,[e[21]||(e[21]=i("確定要刪除用戶 ",-1)),n("strong",null,u(null==(s=cl.value)?void 0:s.userName),1),i(" ("+u(null==(h=cl.value)?void 0:h.email)+") 嗎？",1)]),e[22]||(e[22]=n("p",{class:"text-danger"},[n("small",null,"此操作無法復原。")],-1))]),n("div",el,[n("button",{type:"button",class:"btn btn-secondary",onClick:e[7]||(e[7]=l=>rl.value=!1)}," 取消 "),n("button",{type:"button",class:"btn btn-danger",onClick:wl,disabled:ml.value},[ml.value?(p(),t("span",sl,[...e[23]||(e[23]=[n("span",{class:"visually-hidden"},"刪除中...",-1)])])):o("",!0),e[24]||(e[24]=i(" 確認刪除 ",-1))],8,al)])])])])):o("",!0)])}}}),[["__scopeId","data-v-99a99fc4"]]);export{tl as default};
