import{a,r as e,E as l,y as o,o as s,k as t,l as d,t as i,B as r,n as c,z as n,A as p,v as u,D as m,F as b,s as v,q as f,m as y,w as g,b as w,e as h,p as I}from"./vendor-vue-IgQ0LSVQ.js";import{c as k,d as x,a as N}from"./index.esm-2TNS0yvW.js";import{c as P}from"./crudService-DdbbeSrH.js";import{u as j}from"./notificationStore-Dw0I-Rqg.js";import{_ as U}from"./_plugin-vue_export-helper-BCo6x5W8.js";import"./index-D0JmamB5.js";const D={class:"card shadow border-0 my-4 fw-bold"},V={class:"card-header bg-secondary bg-gradient ml-0 py-3"},_={class:"row"},E={class:"col-12 text-center"},S={class:"text-white py-2"},Y={class:"card-body p-4 fw-bold"},q={class:"row"},A={class:"col-10"},F={class:"border p-3"},O={class:"form-floating py-2 col-12 fw-bold"},B={key:0,class:"invalid-feedback"},C={class:"form-floating py-2 col-12 fw-bold"},T={key:0,class:"invalid-feedback"},$={class:"form-floating py-2 col-12"},z={class:"form-floating py-2 col-12"},L={key:0,class:"invalid-feedback"},M={class:"form-floating py-2 col-12"},G=["value"],H={key:0,class:"invalid-feedback"},J={class:"form-floating py-2 col-12"},K=["value"],Q={key:0,class:"invalid-feedback"},R={class:"form-floating py-2 col-12"},W={class:"py-2 col-12"},X={class:"form-floating py-2 col-12"},Z={class:"row pt-2 fw-bold"},aa={class:"col-6 col-md-3"},ea=["disabled"],la={key:0,class:"spinner-border spinner-border-sm me-2"},oa={class:"col-6 col-md-3"},sa={key:0,class:"alert alert-danger mt-3 fw-bold"},ta={class:"col-2"},da={key:0},ia=["src"],ra=["onClick"],ca=U(a({__name:"FormView",setup(a){const U=I(),ca=l(),na=j(),pa=P("/product"),ua=P("/category"),ma=P("/company"),ba=e(!1),va=e(null),fa=e(!!ca.params.id),ya=e([]),ga=e([]),wa=e([]),ha=o({id:void 0,title:"",description:"",isbn:"",categoryId:void 0,companyId:void 0,hDate:"",heldYN:"N",listPrice:0,productImages:[]}),Ia=o({}),ka=k({title:N().required("活動名稱為必填"),isbn:N().required("活動簡介為必填"),categoryId:x().required("類別為必填"),companyId:x().required("主辦單位為必填"),listPrice:x().required("費用為必填").min(0)});async function xa(a){const e=a.target.files;e&&(wa.value=Array.from(e))}async function Na(){var a,e,l;va.value=null;if(await async function(){try{return await ka.validate(ha,{abortEarly:!1}),Object.keys(Ia).forEach(a=>delete Ia[a]),!0}catch(a){if(Object.keys(Ia).forEach(a=>delete Ia[a]),a.inner)for(const e of a.inner)e.path&&(Ia[e.path]=e.message);return!1}}()){ba.value=!0;try{const o=new FormData;o.append("title",ha.title||""),o.append("description",ha.description||""),o.append("isbn",ha.isbn||""),o.append("categoryId",(null==(a=ha.categoryId)?void 0:a.toString())||""),o.append("companyId",(null==(e=ha.companyId)?void 0:e.toString())||""),o.append("hDate",ha.hDate||""),o.append("heldYN",ha.heldYN||"N"),o.append("listPrice",(null==(l=ha.listPrice)?void 0:l.toString())||"0");for(const a of wa.value)o.append("files",a);fa.value&&ha.id?(await fetch(`/api/product/${ha.id}`,{method:"PUT",body:o}),na.success("活動已更新")):(await fetch("/api/product",{method:"POST",body:o}),na.success("活動已新增")),U.push("/app/product")}catch(o){va.value=(null==o?void 0:o.message)||"操作失敗"}finally{ba.value=!1}}}return s(async()=>{if(await async function(){var a;try{const{data:e}=await ua.list();(null==e?void 0:e.data)&&(ya.value=Array.isArray(e.data)?e.data:(null==(a=e.data)?void 0:a.items)||[])}catch(e){console.error("Failed to load categories:",e)}}(),await async function(){var a;try{const{data:e}=await ma.list();(null==e?void 0:e.data)&&(ga.value=Array.isArray(e.data)?e.data:(null==(a=e.data)?void 0:a.items)||[])}catch(e){console.error("Failed to load companies:",e)}}(),fa.value&&ca.params.id)try{const{data:a}=await pa.getById(Number(ca.params.id));Object.assign(ha,a.data)}catch(a){va.value=(null==a?void 0:a.message)||"加載失敗"}}),(a,e)=>{const l=w("router-link");return h(),t("div",D,[d("div",V,[d("div",_,[d("div",E,[d("h5",S,i(fa.value?"修改":"新增")+"活動",1)])])]),d("div",Y,[d("form",{onSubmit:r(Na,["prevent"]),enctype:"multipart/form-data",novalidate:"",class:"row"},[d("div",q,[d("div",A,[d("div",F,[d("div",O,[n(d("input",{"onUpdate:modelValue":e[0]||(e[0]=a=>ha.title=a),type:"text",class:u(["form-control border-0 shadow text-bg-info fw-bold",{"is-invalid":Ia.title}]),placeholder:"活動名稱"},null,2),[[p,ha.title]]),e[8]||(e[8]=d("label",{class:"ms-2 fw-bold"},"活動名稱 *",-1)),Ia.title?(h(),t("div",B,i(Ia.title),1)):c("",!0)]),d("div",C,[n(d("input",{"onUpdate:modelValue":e[1]||(e[1]=a=>ha.isbn=a),type:"text",class:u(["form-control border-0 shadow fw-bold",{"is-invalid":Ia.isbn}]),placeholder:"活動簡介"},null,2),[[p,ha.isbn]]),e[9]||(e[9]=d("label",{class:"ms-2 fw-bold"},"活動簡介 *",-1)),Ia.isbn?(h(),t("div",T,i(Ia.isbn),1)):c("",!0)]),d("div",$,[n(d("input",{"onUpdate:modelValue":e[2]||(e[2]=a=>ha.hDate=a),type:"text",class:"form-control border-0 shadow",placeholder:"活動日期"},null,512),[[p,ha.hDate]]),e[10]||(e[10]=d("label",{class:"ms-2"},"活動日期",-1))]),d("div",z,[n(d("input",{"onUpdate:modelValue":e[3]||(e[3]=a=>ha.listPrice=a),type:"number",step:"0.01",class:u(["form-control border-0 shadow",{"is-invalid":Ia.listPrice}]),placeholder:"費用"},null,2),[[p,ha.listPrice,void 0,{number:!0}]]),e[11]||(e[11]=d("label",{class:"ms-2"},"一般費用 *",-1)),Ia.listPrice?(h(),t("div",L,i(Ia.listPrice),1)):c("",!0)]),d("div",M,[n(d("select",{"onUpdate:modelValue":e[4]||(e[4]=a=>ha.categoryId=a),class:u(["form-select border-0 shadow",{"is-invalid":Ia.categoryId}])},[e[12]||(e[12]=d("option",{disabled:"",value:""},"--選活動類別--",-1)),(h(!0),t(b,null,v(ya.value,a=>(h(),t("option",{key:a.categoryId,value:a.categoryId},i(a.name),9,G))),128))],2),[[m,ha.categoryId,void 0,{number:!0}]]),e[13]||(e[13]=d("label",{class:"ms-2 fw-bold"},"活動類別 *",-1)),Ia.categoryId?(h(),t("div",H,i(Ia.categoryId),1)):c("",!0)]),d("div",J,[n(d("select",{"onUpdate:modelValue":e[5]||(e[5]=a=>ha.companyId=a),class:u(["form-select border-0 shadow text-bg-info fw-bold",{"is-invalid":Ia.companyId}])},[e[14]||(e[14]=d("option",{disabled:"",value:""},"--選主辦單位--",-1)),(h(!0),t(b,null,v(ga.value,a=>(h(),t("option",{key:a.companyId,value:a.companyId},i(a.name),9,K))),128))],2),[[m,ha.companyId,void 0,{number:!0}]]),e[15]||(e[15]=d("label",{class:"ms-2 fw-bold"},"主辦單位 *",-1)),Ia.companyId?(h(),t("div",Q,i(Ia.companyId),1)):c("",!0)]),d("div",R,[n(d("select",{"onUpdate:modelValue":e[6]||(e[6]=a=>ha.heldYN=a),class:"form-select border-0 text-bg-warning shadow"},[...e[16]||(e[16]=[d("option",{value:"Y"},"是",-1),d("option",{value:"N"},"否",-1)])],512),[[m,ha.heldYN]]),e[17]||(e[17]=d("label",{class:"ms-2 fw-bold"},"是否舉辦(是Y/否N) *",-1))]),d("div",W,[e[18]||(e[18]=d("label",{class:"ms-2 fw-bold"},"說明",-1)),n(d("textarea",{"onUpdate:modelValue":e[7]||(e[7]=a=>ha.description=a),class:"form-control border-0 shadow text-bg-info fw-bold",rows:"14",cols:"150"},null,512),[[p,ha.description]])]),d("div",X,[d("input",{type:"file",name:"files",multiple:"",class:"form-control border-0 shadow fw-bold",onChange:xa},null,32),e[19]||(e[19]=d("label",{class:"ms-2 fw-bold"},"上傳DM照片",-1))]),d("div",Z,[d("div",aa,[d("button",{type:"submit",class:"btn btn-primary form-control fw-bold",disabled:ba.value},[ba.value?(h(),t("span",la)):c("",!0),f(" "+i(fa.value?"修改":"新增"),1)],8,ea)]),d("div",oa,[y(l,{to:"/app/product",class:"btn btn-outline-primary border form-control fw-bold"},{default:g(()=>[...e[20]||(e[20]=[f(" 回清單 ",-1)])]),_:1})])]),va.value?(h(),t("div",sa,i(va.value),1)):c("",!0)])]),d("div",ta,[ha.productImages&&ha.productImages.length>0?(h(),t("div",da,[(h(!0),t(b,null,v(ha.productImages,a=>(h(),t("div",{key:a.id,class:"border p-1 m-2 text-center"},[d("img",{src:a.imageUrl,width:"100%",style:{"border-radius":"5px",border:"1px solid #bbb9b9"},alt:"活動圖片"},null,8,ia),d("button",{type:"button",class:"btn btn-danger btn-sm mt-2 fw-bold",onClick:e=>async function(a){if(confirm("確定要刪除此圖片嗎？"))try{if(await fetch(`/api/product/image/${a}`,{method:"DELETE"}),na.success("圖片已刪除"),fa.value&&ca.params.id){const{data:a}=await pa.getById(Number(ca.params.id));Object.assign(ha,a.data)}}catch(e){na.error((null==e?void 0:e.message)||"刪除圖片失敗")}}(a.id)},[...e[21]||(e[21]=[d("i",{class:"bi bi-trash-fill"},null,-1),f(" 刪除 ",-1)])],8,ra)]))),128))])):c("",!0)])])],32)])])}}}),[["__scopeId","data-v-2c18a09b"]]);export{ca as default};
